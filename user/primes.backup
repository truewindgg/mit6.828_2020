#include "kernel/types.h"
#include "user/user.h"

int main(){
    int fp[2];
    if(pipe(fp) < 0){
        fprintf(2, "init pipe ERROR\n");
    }
    for(int i=2; i<=35; ++i){
        write(fp[1], &i, sizeof(int));
    }
    int number = 0;
    write(fp[1], &number, sizeof(int));
    int pid = fork();
    if(pid < 0){
        fprintf(2, "fork ERROR\n");
    }else if(pid == 0){
        while(read(fp[0], &number, sizeof(int))){
            fprintf(1, "prime %d\n", number);
            int empty = 1;
            int curNumber = number;
            while(read(fp[0], &number, sizeof(int)) && number!=0){
                empty = 0;             
                if(number % curNumber != 0){
                    write(fp[1], &number, sizeof(int));
                }
            }
            if(empty){
                close(fp[1]);
                break;
            }else{
                number = 0;
                write(fp[1], &number, sizeof(int));
            }
            if(fork()!=0){
                wait(0);
                break;
            }
        }
    }else{
        wait(0);
    }
    exit(0);
}
